<!DOCTYPE html>
<html>
<head>
    <title>Inria Museum</title>
    <link rel="stylesheet" type="text/css" href="InriaMuseum.css"> 
    <script>
        var current_page; 
        var previous_page;
        var f_call_change_map = false; // if f_call_change_map, execute change_map()
        var num_people;
        var num_people_detected = 0;
        var fetch_detect = {};
        var broadcast_address =  "ff-ff-ff-ff-ff-ff-ff-ff";
        var f_play_harry_potter = false;
        var f_play_star_wars = false;
        var srcPort = 61624;
        var destPort = 61624;
        var priority = 2;
        var options = 0;
        var US_active = 0x02;
        var f_send_data = 0;
        var play_Star_Wars = 0x03;
        var play_Harry_Potter = 0x04;
        var motes_positions_labels = ["machine_board", "xplore_board", "algorithme_board", "language_board",
                                      "information_board", "robotique_board", "apprentissage_board",
                                      "reseau_board", "big_data_board"]
        var motes_positions = { 
                        "machine_board": "00-17-0D-00-00-70-1A-06", 
                        "xplore_board":  "00-17-0D-00-00-33-F3-4E", 
                        "algorithme_board": "00-17-0D-00-00-70-1C-A3",
                        "language_board": "00-17-0D-00-00-70-1C-9B", 
                        "information_board": "00-17-0D-00-00-68-0B-EC", 
                        "robotique_board": "00-17-0D-00-00-68-0A-AB",
                        "apprentissage_board": "00-17-0D-00-00-68-0D-3A",
                        "reseau_board": "00-17-0D-00-00-70-53-BA",
                        "big_data_board" :"00-17-0D-00-00-68-0B-04"
        }
        //event listener for buttons
        function handleButtonClick(event) { 
            if(event.target.id == ""){
                const parentElementId = event.target.parentElement ?
                event.target.parentElement.id : 'No parent element';
                changePage(parentElementId);
            }else{
                changePage(event.target.id);
            }
        }
        function changePage(parent_element) {
            switch (parent_element) {
                case "button_start_fr":
                    current_page='launching.svg';
                    break;
                case "button_active": 
                    current_page='map.svg';
                    break;
                case "button_suite":
                    current_page='select_music.svg'
                    break;
                    case "button_music1" :
                    f_play_harry_potter = true;
                    f_play_star_wars = false;
                    current_page = "num_people.svg";
                    break;
                case "button_music2" :
                    f_play_star_wars = true;
                    f_play_harry_potter = false;
                    current_page = "num_people.svg";
                    break;
                    case "button_num_people_1":
                    num_people = 1;
                    current_page='map.svg';
                    f_call_change_map = true;
                    break;
                case "button_num_people_2":
                    num_people = 2;
                    current_page='map.svg';
                    f_call_change_map = true;
                    break;
                case "button_num_people_3":
                    num_people = 3;
                    current_page='map.svg';
                    f_call_change_map = true;
                    break;
                case "button_num_people_4":
                    num_people = 4;
                    current_page='map.svg';
                    f_call_change_map = true;
                    break;
                case "button_credits":
                    previous_page = current_page;
                    current_page='credits.svg';
                    break;
                case "button_leave":
                    current_page = previous_page;
                    break;
                default :
                    console.log(`default ${parent_element} `); 
                    break;
            }
            loadSVG(current_page);
            checkPage();
        }
        function send_data_to_mote(macAddress, priority, srcPort, dstPort, options, data) {
            // Prepare the data to send in the body of the POST request
            var payload = {
                macAddress: macAddress,
                priority: priority,
                srcPort: srcPort,
                dstPort: destPort,
                options: options,
                data: data
            };
            fetch('/send_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })//Handle the Serverâ€™s Response
            .then(response => console.log(response))
            .then(payload => {
                console.log(payload);
            })//Error Handling
            .catch(error => {
                console.error('Error:', error);
            });
        }
        async function detecting_notifications() {
            try {
                const response = await fetch('/detecting');
                if (!response.ok) {
                    throw new Error(`Response status: ${response.status}`);
                }
                // {m0: 0/1, m1: 0/1 .... m8: 0/1}
                fetch_detect = await response.json();
                } catch (error) {
                    console.error('Error fetching detecting:', error.message);
                }
        }
        // Change mote circles from grey to green to indicate that they are part of the network
        function active_motes(grey_motes_ids,r1, r2, r3, r4){
            grey_motes_ids.forEach(mote => {
                    const mote_grey_circle = document.getElementById(mote);
                    if (!mote_grey_circle) {
                        console.error("mote not found");
                        return; 
                    }
                    const cx = mote_grey_circle.getAttribute("cx");
                    const cy = mote_grey_circle.getAttribute("cy"); 
                    // Create a new <g> element
                    const active_circle = document.createElementNS("http://www.w3.org/2000/svg", "g");
                    active_circle.setAttribute("id", `active ${mote}`);
                    // Define the new green circle
                    const active_circle_Data = [
                        { class: "cls-5", cx: cx,    cy: cy, r: r1 },
                        { class: "cls-3", cx: cx,    cy: cy, r: r2 },
                        { class: "cls-2", cx: cx,    cy: cy, r: r3 },
                        { class: "cls-4", cx: cx,    cy: cy, r: r4 },
                    ];
                    // Create the green circle and append it to the active_circle group
                    active_circle_Data.forEach(circleData => {
                        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                        circle.setAttribute("class", circleData.class);
                        circle.setAttribute("cx", circleData.cx);
                        circle.setAttribute("cy", circleData.cy);
                        circle.setAttribute("r", circleData.r);
                        active_circle.appendChild(circle);
                        });
                    // Replace the existing circle with the new group
                    if (mote_grey_circle && mote_grey_circle.parentNode) {
                        mote_grey_circle.parentNode.replaceChild(active_circle, mote_grey_circle);
                        console.log("element replaced");
                        }
                })  
        }
        // change board color of chosen positions to orange
        function change_color(chosen_positions){
            chosen_positions.forEach(position => {
                const mote_board = document.getElementById(motes_positions_labels[position]);
                console.log(`${mote_board}`);
                if (!mote_board) {
                    console.error("Board not found");
                    return; 
                }
                mote_board.setAttribute("class", "cls-14");
            })
        }
        function add_logo(add_logo_dict,position, position_label , radius){
            const id = position_label.replace("_board", "");
            const detect = document.getElementById(`${id}_detect`)
            if (detect) {
                const path = detect.querySelector("path.cls-14");
                const circle = detect.querySelector("circle.cls-14");
                if (path && circle) {
                        path.setAttribute("d", add_logo_dict[position][0]);
                        circle.setAttribute("cx", add_logo_dict[position][1]);
                        circle.setAttribute("cy", add_logo_dict[position][2]);
                        circle.setAttribute("r", radius);
                        circle.setAttribute("transform", add_logo_dict[position][3]);
                }
            }
        }
        function change_map(){
            // radiuses of circles composing the active mote circle
            const r1= 12.19;
            const r2= 20.08;
            const r3= 25.08;
            const r4= 28.00;
            const radius = 13.33;
            const num_positions = 9;
            const grey_motes_ids = [
                    "hall_mote1", "hall_mote2","hall_mote3","hall_mote4",
                    "hall_mote5", "hall_mote6", "expo_mote1", "expo_mote2", 
                    "expo_mote3", "expo_mote4", "expo_mote5", "machine_mote", 
                    "xplore_mote", "algorithme_mote", "language_mote", 
                    "information_mote", "robotique_mote", "apprentissage_mote",
                    "reseau_mote", "big_data_mote"
                ];
            active_motes(grey_motes_ids, r1, r2, r3, r4);
            //pick randomly n positions and change board color to orange
            const motes_positions_labels = ["machine_board", "xplore_board", "algorithme_board", "language_board",
                                        "information_board", "robotique_board", "apprentissage_board",
                                        "reseau_board", "big_data_board"]
            const motes_positions = { 
                        "machine_board": "00-17-0D-00-00-70-1A-06", 
                        "xplore_board":  "00-17-0D-00-00-33-F3-4E", 
                        "algorithme_board": "00-17-0D-00-00-70-1C-A3",
                        "language_board": "00-17-0D-00-00-70-1C-9B", 
                        "information_board": "00-17-0D-00-00-68-0B-EC", 
                        "robotique_board": "00-17-0D-00-00-68-0A-AB",
                        "apprentissage_board": "00-17-0D-00-00-68-0D-3A",
                        "reseau_board": "00-17-0D-00-00-70-53-BA",
                        "big_data_board" :"00-17-0D-00-00-68-0B-04"
                }
            // Set of n unique random integers between min = 0 and max = num_positions-1 = 8
            const random_set = (min, max, n = 1) => {
                const uniqueNumbers = new Set();
                while (uniqueNumbers.size < n) {
                    const randomNum = Math.floor(Math.random() * (max - min + 1)) + min;
                    uniqueNumbers.add(randomNum); 
                }
                return Array.from(uniqueNumbers);
            }
            let chosen_positions = random_set(0, num_positions - 1, num_people);
            change_color(chosen_positions);
            // Check if person is in the specified position, if so add a person logo
            // {mote_index: [d, cx, cy, transform]} 
            let add_logo_dict= {
                    0: ["m1184.87,548.46c-6-4.06-26.11-4.06-32.1,0-5.38,3.64-5.92,15.17-5.97,17.44-.02.7.25,1.38.74,1.88.49.5,1.16.78,1.86.78h38.85c.7,0,1.37-.28,1.86-.78.49-.5.76-1.18.74-1.88-.05-2.27-.59-13.8-5.97-17.44Z",
                        "1168.82", 
                        "527.89", 
                        "translate(-87.79 271.49) rotate(-12.77)" 
                        ],
                    1: ["m846.05,581.79c-6-4.06-26.11-4.06-32.1,0-5.38,3.64-5.92,15.17-5.97,17.44-.02.7.25,1.38.74,1.88.49.5,1.16.78,1.86.78h38.85c.7,0,1.37-.28,1.86-.78.49-.5.76-1.18.74-1.88-.05-2.27-.59-13.8-5.97-17.44Z",
                        "830",
                        "561.22",
                        "translate(-103.54 197.4) rotate(-12.77)"
                        ],
                    2 : ["m809.96,386.8c-1.81-7.02-16.88-20.32-24.07-21.25-6.44-.83-14.47,7.45-16.02,9.12-.48.51-.72,1.2-.69,1.9.03.7.35,1.35.88,1.82l29.12,25.71c.52.46,1.21.69,1.91.64.7-.05,1.35-.38,1.8-.92,1.46-1.74,8.69-10.74,7.07-17.03Z",
                        "811.54",
                        "360.75",
                        "translate(105.69 899.74) rotate(-61.33)"
                        ],

                    3: ["m516.55,263.9c-6-4.06-26.11-4.06-32.1,0-5.38,3.64-5.92,15.17-5.97,17.44-.02.7.25,1.38.74,1.88.49.5,1.16.78,1.86.78h38.85c.7,0,1.37-.28,1.86-.78.49-.5.76-1.18.74-1.88-.05-2.27-.59-13.8-5.97-17.44Z",
                        "500.5",
                        "243.33",
                        "translate(-41.41 116.68) rotate(-12.77)"
                    ],
                    4: ["m240.18,333.9c-6-4.06-26.11-4.06-32.1,0-5.38,3.64-5.92,15.17-5.97,17.44-.02.7.25,1.38.74,1.88.49.5,1.16.78,1.86.78h38.85c.7,0,1.37-.28,1.86-.78.49-.5.76-1.18.74-1.88-.05-2.27-.59-13.8-5.97-17.44Z",
                        "224.13",
                        "313.33",
                        "translate(-63.73 57.31) rotate(-12.77)"
                    ],
                    5: ["m240.18,525.9c-6-4.06-26.11-4.06-32.1,0-5.38,3.64-5.92,15.17-5.97,17.44-.02.7.25,1.38.74,1.88.49.5,1.16.78,1.86.78h38.85c.7,0,1.37-.28,1.86-.78.49-.5.76-1.18.74-1.88-.05-2.27-.59-13.8-5.97-17.44Z",
                        "224.13",
                        "505.33",
                        "translate(-106.18 62.06) rotate(-12.77)"
                    ],
                    6: ["m257.7,728.49c-2.08-6.94-17.66-19.65-24.87-20.3-6.47-.58-14.17,8.01-15.65,9.74-.45.53-.68,1.22-.61,1.92.06.7.4,1.34.95,1.78l30.1,24.56c.54.44,1.24.65,1.93.57.7-.08,1.33-.43,1.76-.99,1.4-1.79,8.27-11.06,6.4-17.29Z",
                        "258.27",
                        "702.41",
                        "translate(-485.66 620.86) rotate(-63.56)",
                    ],
                    7: ["m482.42,780.78c-6-4.06-26.11-4.06-32.1,0-5.38,3.64-5.92,15.17-5.97,17.44-.02.7.25,1.38.74,1.88.49.5,1.16.78,1.86.78h38.85c.7,0,1.37-.28,1.86-.78.49-.5.76-1.18.74-1.88-.05-2.27-.59-13.8-5.97-17.44Z",
                        "466.36",
                        "760.21",
                        "translate(-156.54 121.93) rotate(-12.77)"
                    ],
                    8: ["m709.56,780.78c-6-4.06-26.11-4.06-32.1,0-5.38,3.64-5.92,15.17-5.97,17.44-.02.7.25,1.38.74,1.88.49.5,1.16.78,1.86.78h38.85c.7,0,1.37-.28,1.86-.78.49-.5.76-1.18.74-1.88-.05-2.27-.59-13.8-5.97-17.44Z",
                        "693.5",
                        "760.21",
                        "translate(-150.92 172.15) rotate(-12.77)"
                    ]
                }
            // detected_positions contains the mac addresses of the motes where the users are detected
            let detected_positions = new Set();
                // recheck detection every 5s
                const intervalId= setInterval(() => {
                    detecting_notifications();
                    for (let i = 0; i< num_people; i ++ ){
                        let position = chosen_positions[i];
                        let position_label = motes_positions_labels[position];                    
                        let mac_address = (motes_positions[position_label]).toLowerCase();
                        // to ensure send_data_to_mote is only run num_people times
                        if (f_send_data < num_people){
                            send_data_to_mote(mac_address, priority, srcPort, destPort, options, US_active);
                            f_send_data ++;
                        }
                        if ((detected_positions.has(mac_address)) === false){
                        // if a person is detected, add person logo in the appropriate position
                            if(fetch_detect[mac_address] == 1){
                                // Add mote to the list of detected motes
                                detected_positions.add(mac_address);
                                num_people_detected++;
                                add_logo(add_logo_dict, position, position_label, radius);
                                if (num_people == num_people_detected){
                                    if (f_play_harry_potter){
                                        send_data_to_mote(broadcast_address,priority, srcPort, destPort, options,play_Harry_Potter);
                                    }
                                    else if(f_play_star_wars){
                                        send_data_to_mote(broadcast_address,priority, srcPort, destPort, options,play_Star_Wars);
                                    }
                                    clearInterval(intervalId);
                            }
                        } 
                    }
                }
            },5000);
        }
        function checkPage() {
            console.log("fct checkPage");
            // display defi page(introduction.svg) after 3s
            if(current_page=="launching.svg"){
                current_page = "introduction.svg";
                setTimeout(function(){
                     loadSVG(current_page);
                     }, 3000);
            }
        }
        function loadSVG(filename) {
            console.log("fct loadSVG");
            const filePath = `svg/${filename}`;
            console.log(`New page ${filename} `);
            fetch(filePath)
                .then(response => response.text())
                .then(svgContent => {
                    document.getElementById('svgContainer').innerHTML = svgContent;
                    activate_buttons();
                    if (f_call_change_map){
                        change_map(); // Ensuring it is called after map is loaded
                    }
                })
                .catch(error => console.error('Error loading SVG:', error));
        }
        function activate_buttons() { 
            console.log("fct load element");
            const button_ids = ["button_start_fr", "button_active", 
                        "button_suite_group", "button_music1", "button_music2",
                        "button_num_people_1", "button_num_people_2", "button_num_people_3", "button_num_people_4",
                        "button_credits" ,"button_leave"];
            // Set inactivity timeout (5 minutes in milliseconds)
            const INACTIVITY_TIMEOUT = 5 * 60 * 1000;
            // Function to redirect to welcome page
            // after 5 minutes of no clicks
            function redirectToWelcome() {
                let redirect_page = "welcome.svg"
                loadSVG(redirect_page);
            }
            // Reset the inactivity timer function
            function resetInactivityTimer() {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(redirectToWelcome, INACTIVITY_TIMEOUT); // 5-minute timeout
            }        
            let inactivityTimer = setTimeout(redirectToWelcome, INACTIVITY_TIMEOUT); // Initial timer
            button_ids.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener("click", (event) => {
                        handleButtonClick(event);
                        resetInactivityTimer(); // Reset timer on each click
                    });
                    console.log(`Event listener attached to: ${id}`);
                } else {
                    console.log(`Element with id ${id} not found`);
                }
            });
        }
        window.onload = function() {
            loadSVG('welcome.svg');
        }
    </script>
</head>
<body>
    <section id="svgContainer" class="doc">
    </section>
</body>
</html>